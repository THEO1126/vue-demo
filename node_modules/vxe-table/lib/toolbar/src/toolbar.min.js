"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_size=_interopRequireDefault(require("../../mixins/size")),_utils=_interopRequireDefault(require("../../tools/utils")),_dom=_interopRequireDefault(require("../../tools/dom")),_vn=require("../../tools/vn"),_event=require("../../tools/event"),_log=require("../../tools/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var renderDropdowns=function(e,o,t,n){var i=o._e,t=t.dropdowns;return t?t.map(function(t){return!1===t.visible?i():e("vxe-button",{on:{click:function(e){return n?o.btnEvent(e,t):o.tolEvent(e,t)}},props:{disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name}})}):[]};function renderBtns(i,s){var r=s._e,e=s.$scopedSlots,l=s.$xegrid,c=s.$xetable,t=s.buttons,t=void 0===t?[]:t,e=e.buttons;return e?e.call(s,{$grid:l,$table:c},i):t.map(function(t){var e=t.dropdowns,o=t.buttonRender,n=o?_vXETable.default.renderer.get(o.name):null;if(!1===t.visible)return r();if(n){n=n.renderToolbarButton||n.renderButton;if(n)return i("span",{class:"vxe-button--item"},(0,_vn.getSlotVNs)(n.call(s,i,o,{$grid:l,$table:c,button:t})))}return i("vxe-button",{on:{click:function(e){return s.btnEvent(e,t)}},props:{disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name,destroyOnClose:t.destroyOnClose,placement:t.placement,transfer:t.transfer},scopedSlots:e&&e.length?{dropdowns:function(){return renderDropdowns(i,s,t,!0)}}:null})})}function renderRightTools(i,s){var r=s._e,e=s.$scopedSlots,l=s.$xegrid,c=s.$xetable,t=s.tools,t=void 0===t?[]:t,e=e.tools;return e?e.call(s,{$grid:l,$table:c},i):t.map(function(t){var e=t.dropdowns,o=t.toolRender,n=o?_vXETable.default.renderer.get(o.name):null;if(!1===t.visible)return r();if(n){n=n.renderToolbarTool;if(n)return i("span",{class:"vxe-tool--item"},(0,_vn.getSlotVNs)(n.call(s,i,o,{$grid:l,$table:c,tool:t})))}return i("vxe-button",{on:{click:function(e){return s.tolEvent(e,t)}},props:{disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name,destroyOnClose:t.destroyOnClose,placement:t.placement,transfer:t.transfer},scopedSlots:e&&e.length?{dropdowns:function(){return renderDropdowns(i,s,t,!1)}}:null})})}function renderCustoms(r,l){var e=l.$xetable,t=l.customStore,o=l.customOpts,n=l.columns,c=[],i={},s={},u=e?e.customOpts.checkMethod:null,e=("manual"!==o.trigger&&("hover"===o.trigger?(i.mouseenter=l.handleMouseenterSettingEvent,i.mouseleave=l.handleMouseleaveSettingEvent,s.mouseenter=l.handleWrapperMouseenterEvent,s.mouseleave=l.handleWrapperMouseleaveEvent):i.click=l.handleClickSettingEvent),_xeUtils.default.eachTree(n,function(e){var t,o=_utils.default.formatText(e.getTitle(),1),n=e.getKey(),i=e.children&&e.children.length,s=!!u&&!u({column:e});(i||n)&&(n=e.visible,t=e.halfVisible,c.push(r("li",{class:["vxe-custom--option","level--".concat(e.level),{"is--group":i,"is--checked":n,"is--indeterminate":t,"is--disabled":s}],attrs:{title:o},on:{click:function(){s||l.changeCustomOption(e)}}},[r("span",{class:["vxe-checkbox--icon",t?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:n?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),r("span",{class:"vxe-checkbox--label"},o)])))}),t.isAll),n=t.isIndeterminate;return r("div",{class:["vxe-custom--wrapper",{"is--active":t.visible}],ref:"customWrapper"},[r("vxe-button",{props:{circle:!0,icon:o.icon||_conf.default.icon.TOOLBAR_TOOLS_CUSTOM},attrs:{title:_conf.default.i18n("vxe.toolbar.custom")},on:i}),r("div",{class:"vxe-custom--option-wrapper"},[r("ul",{class:"vxe-custom--header"},[r("li",{class:["vxe-custom--option",{"is--checked":e,"is--indeterminate":n}],attrs:{title:_conf.default.i18n("vxe.table.allTitle")},on:{click:l.allCustomEvent}},[r("span",{class:["vxe-checkbox--icon",n?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:e?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),r("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])]),r("ul",{class:"vxe-custom--body",on:s},c),!1===o.isFooter?null:r("div",{class:"vxe-custom--footer"},[r("button",{class:"btn--confirm",on:{click:l.confirmCustomEvent}},_conf.default.i18n("vxe.toolbar.customConfirm")),r("button",{class:"btn--reset",on:{click:l.resetCustomEvent}},_conf.default.i18n("vxe.toolbar.customRestore"))])])])}var _default2={name:"VxeToolbar",mixins:[_size.default],props:{loading:Boolean,refresh:[Boolean,Object],import:[Boolean,Object],export:[Boolean,Object],print:[Boolean,Object],zoom:[Boolean,Object],custom:[Boolean,Object],buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},tools:{type:Array,default:function(){return _conf.default.toolbar.tools}},perfect:{type:Boolean,default:function(){return _conf.default.toolbar.perfect}},size:{type:String,default:function(){return _conf.default.toolbar.size||_conf.default.size}},className:[String,Function]},inject:{$xegrid:{default:null}},data:function(){return{$xetable:null,isRefresh:!1,columns:[],customStore:{isAll:!1,isIndeterminate:!1,visible:!1}}},computed:{refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},importOpts:function(){return Object.assign({},_conf.default.toolbar.import,this.import)},exportOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},printOpts:function(){return Object.assign({},_conf.default.toolbar.print,this.print)},zoomOpts:function(){return Object.assign({},_conf.default.toolbar.zoom,this.zoom)},customOpts:function(){return Object.assign({},_conf.default.toolbar.custom,this.custom)}},created:function(){var o=this,n=this.refresh,i=this.refreshOpts;this.$nextTick(function(){var e=o.fintTable(),t=i.queryMethod||i.query;!n||o.$xegrid||t||(0,_log.warnLog)("vxe.error.notFunc",["queryMethod"]),e&&e.connect(o),"development"===process.env.NODE_ENV&&o.buttons&&o.buttons.forEach(function(e){e=e.buttonRender,e=e?_vXETable.default.renderer.get(e.name):null;e&&e.renderButton&&(0,_log.warnLog)("vxe.error.delFunc",["renderButton","renderToolbarButton"])})}),_event.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_event.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_event.GlobalEvent.off(this,"mousedown"),_event.GlobalEvent.off(this,"blur")},render:function(e){var t=this._e,o=this.$xegrid,n=this.perfect,i=this.loading,s=this.importOpts,r=this.exportOpts,l=this.refresh,c=this.refreshOpts,u=this.zoom,a=this.zoomOpts,f=this.custom,d=this.vSize,h=this.className;return e("div",{class:["vxe-toolbar",h?_xeUtils.default.isFunction(h)?h({$toolbar:this}):h:"",(_defineProperty(h={},"size--".concat(d),d),_defineProperty(h,"is--perfect",n),_defineProperty(h,"is--loading",i),h)]},[e("div",{class:"vxe-buttons--wrapper"},renderBtns(e,this)),e("div",{class:"vxe-tools--wrapper"},renderRightTools(e,this)),e("div",{class:"vxe-tools--operate"},[this.import?e("vxe-button",{props:{circle:!0,icon:s.icon||_conf.default.icon.TOOLBAR_TOOLS_IMPORT},attrs:{title:_conf.default.i18n("vxe.toolbar.import")},on:{click:this.importEvent}}):t(),this.export?e("vxe-button",{props:{circle:!0,icon:r.icon||_conf.default.icon.TOOLBAR_TOOLS_EXPORT},attrs:{title:_conf.default.i18n("vxe.toolbar.export")},on:{click:this.exportEvent}}):t(),this.print?e("vxe-button",{props:{circle:!0,icon:this.printOpts.icon||_conf.default.icon.TOOLBAR_TOOLS_PRINT},attrs:{title:_conf.default.i18n("vxe.toolbar.print")},on:{click:this.printEvent}}):t(),l?e("vxe-button",{props:{circle:!0,icon:this.isRefresh?c.iconLoading||_conf.default.icon.TOOLBAR_TOOLS_REFRESH_LOADING:c.icon||_conf.default.icon.TOOLBAR_TOOLS_REFRESH},attrs:{title:_conf.default.i18n("vxe.toolbar.refresh")},on:{click:this.refreshEvent}}):t(),u&&o?e("vxe-button",{props:{circle:!0,icon:o.isMaximized()?a.iconOut||_conf.default.icon.TOOLBAR_TOOLS_MINIMIZE:a.iconIn||_conf.default.icon.TOOLBAR_TOOLS_FULLSCREEN},attrs:{title:_conf.default.i18n("vxe.toolbar.zoom".concat(o.isMaximized()?"Out":"In"))},on:{click:o.triggerZoomEvent}}):t(),f?renderCustoms(e,this):t()])])},methods:{syncUpdate:function(e){var t=e.collectColumn,e=e.$table;this.$xetable=e,this.columns=t},fintTable:function(){var e=this.$parent.$children,o=e.indexOf(this);return _xeUtils.default.find(e,function(e,t){return e&&e.loadData&&o<t&&"vxe-table"===e.$vnode.componentOptions.tag})},checkTable:function(){if(this.$xetable)return!0;(0,_log.errLog)("vxe.error.barUnableLink")},showCustom:function(){this.customStore.visible=!0,this.checkCustomStatus()},closeCustom:function(){var e=this.custom,t=this.customStore;t.visible&&(t.visible=!1,e)&&!t.immediate&&this.handleTableCustom()},confirmCustomEvent:function(e){this.closeCustom(),this.emitCustomEvent("confirm",e)},customOpenEvent:function(e){var t=this.customStore;this.checkTable()&&!t.visible&&(this.showCustom(),this.emitCustomEvent("open",e))},customColseEvent:function(e){this.customStore.visible&&(this.closeCustom(),this.emitCustomEvent("close",e))},resetCustomEvent:function(e){var t=this.$xetable,o=this.columns,n=t.customOpts.checkMethod;_xeUtils.default.eachTree(o,function(e){n&&!n({column:e})||(e.visible=e.defaultVisible,e.halfVisible=!1),e.resizeWidth=0}),t.saveCustomResizable(!0),this.closeCustom(),this.emitCustomEvent("reset",e)},emitCustomEvent:function(e,t){var o=this.$xetable,n=this.$xegrid;(n||o).$emit("custom",{type:e,$table:o,$grid:n,$event:t})},changeCustomOption:function(e){var t=!e.visible;_xeUtils.default.eachTree([e],function(e){e.visible=t,e.halfVisible=!1}),this.handleOptionCheck(e),this.custom&&this.customOpts.immediate&&this.handleTableCustom(),this.checkCustomStatus()},handleOptionCheck:function(t){var e=_xeUtils.default.findTree(this.columns,function(e){return e===t});e&&e.parent&&(e=e.parent).children&&e.children.length&&(e.visible=e.children.every(function(e){return e.visible}),e.halfVisible=!e.visible&&e.children.some(function(e){return e.visible||e.halfVisible}),this.handleOptionCheck(e))},handleTableCustom:function(){this.$xetable.handleCustom()},checkCustomStatus:function(){var e=this.$xetable,t=this.columns,o=e.customOpts.checkMethod;this.customStore.isAll=t.every(function(e){return!!o&&!o({column:e})||e.visible}),this.customStore.isIndeterminate=!this.customStore.isAll&&t.some(function(e){return(!o||o({column:e}))&&(e.visible||e.halfVisible)})},allCustomEvent:function(){var e=this.$xetable,t=this.columns,o=this.customStore,n=e.customOpts.checkMethod,i=!o.isAll;_xeUtils.default.eachTree(t,function(e){n&&!n({column:e})||(e.visible=i,e.halfVisible=!1)}),o.isAll=i,this.checkCustomStatus()},handleGlobalMousedownEvent:function(e){_dom.default.getEventTargetNode(e,this.$refs.customWrapper).flag||this.customColseEvent(e)},handleGlobalBlurEvent:function(e){this.customColseEvent(e)},handleClickSettingEvent:function(e){this.customStore.visible?this.customColseEvent(e):this.customOpenEvent(e)},handleMouseenterSettingEvent:function(e){this.customStore.activeBtn=!0,this.customOpenEvent(e)},handleMouseleaveSettingEvent:function(e){var t=this,o=this.customStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.customColseEvent(e)},300)},handleWrapperMouseenterEvent:function(e){this.customStore.activeWrapper=!0,this.customOpenEvent(e)},handleWrapperMouseleaveEvent:function(e){var t=this,o=this.customStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||t.customColseEvent(e)},300)},refreshEvent:function(){var e=this,t=this.$xegrid,o=this.refreshOpts;if(!this.isRefresh){var n=o.queryMethod||o.query;if(n){this.isRefresh=!0;try{Promise.resolve(n({})).catch(function(e){return e}).then(function(){e.isRefresh=!1})}catch(e){this.isRefresh=!1}}else t&&(this.isRefresh=!0,t.commitProxy(o.code||"reload").catch(function(e){return e}).then(function(){e.isRefresh=!1}))}},btnEvent:function(e,t){var o=this.$xegrid,n=this.$xetable,i=t.code;i&&(o?o.triggerToolbarBtnEvent(t,e):(t={code:i,button:t,$xegrid:o,$table:n,$event:e},(o=_vXETable.default.commands.get(i))&&o.call(this,t,e),this.$emit("button-click",t)))},tolEvent:function(e,t){var o=this.$xegrid,n=this.$xetable,i=t.code;i&&(o?o.triggerToolbarTolEvent(t,e):(t={code:i,tool:t,$xegrid:o,$table:n,$event:e},(o=_vXETable.default.commands.get(i))&&o.call(this,t,e),this.$emit("tool-click",t)))},importEvent:function(){this.checkTable()&&this.$xetable.openImport(this.importOpts)},exportEvent:function(){this.checkTable()&&this.$xetable.openExport(this.exportOpts)},printEvent:function(){this.checkTable()&&this.$xetable.openPrint(this.printOpts)}}};exports.default=_default2;